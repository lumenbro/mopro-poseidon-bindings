name: Build Mopro React Native Bindings

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  CARGO_TERM_COLOR: always

jobs:
  build-react-native:
    runs-on: macos-14  # Apple Silicon runner (M1/M2) - required for iOS
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios,aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Install mopro CLI
        run: |
          cargo install --git https://github.com/zkmopro/mopro mopro-cli
          mopro --version

      - name: Configure cargo for cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-apple-ios]
          rustflags = ["-C", "link-arg=-mios-version-min=14.0"]

          [target.aarch64-apple-ios-sim]
          rustflags = ["-C", "link-arg=-mios-simulator-version-min=14.0"]

          [target.aarch64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android24-clang"

          [target.armv7-linux-androideabi]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/armv7a-linux-androideabi24-clang"

          [target.x86_64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/x86_64-linux-android24-clang"

          [target.i686-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/i686-linux-android24-clang"
          EOF

      - name: Set Android NDK environment
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Check mopro build help
        run: |
          echo "=== Checking mopro build options ==="
          mopro build --help || true
          echo ""
          echo "=== Checking mopro --help ==="
          mopro --help || true

      - name: Pre-create Config.toml to skip prompts
        run: |
          # Create a Config.toml with all options pre-selected
          cat > Config.toml << 'EOF'
          [build]
          mode = "release"

          [build.react-native]
          architectures = [
            "aarch64-apple-ios",
            "aarch64-apple-ios-sim",
            "aarch64-linux-android",
            "armv7-linux-androideabi",
            "x86_64-linux-android",
            "i686-linux-android"
          ]
          EOF
          echo "=== Created Config.toml ==="
          cat Config.toml

      - name: Build React Native bindings with mopro CLI
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          CI: "true"
          MOPRO_CI: "true"
          TERM: dumb
        run: |
          echo "=== Building React Native bindings ==="
          echo "=== Trying with various flag combinations ==="

          # Try with all flags we can think of
          mopro build \
            --platforms react-native \
            --mode release \
            --arch aarch64-apple-ios,aarch64-apple-ios-sim,aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android \
            2>&1 | tee build.log || {

            echo "=== Full flags failed, trying simpler ==="
            mopro build --platforms react-native --mode release 2>&1 | tee build.log || {

              echo "=== Checking if there's a non-interactive flag ==="
              mopro build --help | grep -i "interactive\|prompt\|ci\|yes\|auto" || true

              echo "=== Trying with yes pipe ==="
              yes | mopro build --platforms react-native 2>&1 | head -1000 | tee build.log || {
                echo "=== All attempts failed ==="
                exit 1
              }
            }
          }

          echo "=== Build complete, listing ALL outputs ==="
          ls -la
          echo ""
          echo "=== Looking for any generated directories ==="
          find . -maxdepth 2 -type d -name "*Binding*" -o -name "*binding*" -o -name "*react*" -o -name "*React*" -o -name "target" 2>/dev/null || true
          echo ""
          echo "=== All directories in current folder ==="
          ls -la */ 2>/dev/null || true
          echo ""
          echo "=== Contents of target if exists ==="
          ls -la target/ 2>/dev/null || echo "No target directory"
          echo ""
          echo "=== build.log contents ==="
          cat build.log 2>/dev/null || echo "No build.log"

      - name: Package React Native bindings
        run: |
          # Look for any of the possible output directory names
          BINDINGS_DIR=""
          for dir in "MoproReactNativeBindings" "mopro-react-native-bindings" "react-native-bindings" "out" "output"; do
            if [ -d "$dir" ]; then
              BINDINGS_DIR="$dir"
              break
            fi
          done

          if [ -n "$BINDINGS_DIR" ]; then
            echo "=== Found bindings directory: $BINDINGS_DIR ==="
            mkdir -p release
            cp -R "$BINDINGS_DIR"/* release/

            echo "=== Package contents ==="
            find release -type f | head -100

            cd release
            zip -r ../mopro-poseidon-react-native.zip .
          else
            echo "=== No bindings directory found, checking for individual outputs ==="
            ls -la

            # Check if we have target directory with built libraries
            if [ -d "target" ]; then
              echo "=== Found target directory, packaging raw build outputs ==="
              mkdir -p release/ios release/android

              # Copy iOS libraries
              find target -name "*.a" -path "*apple-ios*" -exec cp {} release/ios/ \; 2>/dev/null || true

              # Copy Android libraries
              find target -name "*.a" -path "*android*" -exec cp {} release/android/ \; 2>/dev/null || true

              echo "=== Raw build contents ==="
              find release -type f

              if [ "$(find release -type f | wc -l)" -gt 0 ]; then
                cd release
                zip -r ../mopro-poseidon-react-native.zip .
              else
                echo "ERROR: No build outputs found"
                exit 1
              fi
            else
              echo "ERROR: No outputs found at all"
              exit 1
            fi
          fi

      - name: Upload React Native package
        uses: actions/upload-artifact@v4
        with:
          name: mopro-poseidon-react-native
          path: mopro-poseidon-react-native.zip

      - name: Upload individual artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-native-bindings
          path: |
            MoproReactNativeBindings/
