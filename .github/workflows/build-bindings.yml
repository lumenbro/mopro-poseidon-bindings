name: Build Mopro React Native Bindings

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allows manual trigger from GitHub UI

env:
  CARGO_TERM_COLOR: always

jobs:
  build-react-native:
    runs-on: macos-14  # Apple Silicon runner (M1/M2) - required for iOS
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim,x86_64-apple-ios,aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Install mopro CLI
        run: |
          cargo install --git https://github.com/zkmopro/mopro mopro-cli
          mopro --version

      - name: Configure cargo for cross-compilation
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-apple-ios]
          rustflags = ["-C", "link-arg=-mios-version-min=14.0"]

          [target.aarch64-apple-ios-sim]
          rustflags = ["-C", "link-arg=-mios-simulator-version-min=14.0"]

          [target.aarch64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/aarch64-linux-android24-clang"

          [target.armv7-linux-androideabi]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/armv7a-linux-androideabi24-clang"

          [target.x86_64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/x86_64-linux-android24-clang"

          [target.i686-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/darwin-x86_64/bin/i686-linux-android24-clang"
          EOF

      - name: Set Android NDK environment
        run: |
          echo "ANDROID_NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV
          echo "NDK_HOME=${{ steps.setup-ndk.outputs.ndk-path }}" >> $GITHUB_ENV

      - name: Build React Native bindings with mopro CLI
        env:
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
          NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}
        run: |
          echo "=== Building React Native bindings ==="
          mopro build --platforms react-native 2>&1 | tee build.log

          echo "=== Build complete, listing outputs ==="
          ls -la

          if [ -d "MoproReactNativeBindings" ]; then
            echo "=== React Native bindings structure ==="
            find MoproReactNativeBindings -type f | head -50
          fi

      - name: Package React Native bindings
        run: |
          if [ -d "MoproReactNativeBindings" ]; then
            # Create a clean package
            mkdir -p release
            cp -R MoproReactNativeBindings/* release/

            # List what we're packaging
            echo "=== Package contents ==="
            find release -type f | head -100

            # Create zip
            cd release
            zip -r ../mopro-poseidon-react-native.zip .
          else
            echo "ERROR: MoproReactNativeBindings not found"
            exit 1
          fi

      - name: Upload React Native package
        uses: actions/upload-artifact@v4
        with:
          name: mopro-poseidon-react-native
          path: mopro-poseidon-react-native.zip

      - name: Upload individual artifacts
        uses: actions/upload-artifact@v4
        with:
          name: react-native-bindings
          path: |
            MoproReactNativeBindings/
