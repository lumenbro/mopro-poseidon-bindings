name: Build Bindings (Manual - No Mopro CLI)

on:
  workflow_dispatch:  # Manual trigger only

env:
  CARGO_TERM_COLOR: always

jobs:
  build-ios:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim

      - name: Install uniffi-bindgen-react-native
        run: |
          # Install from git - not on crates.io
          cargo install --git https://github.com/jhugman/uniffi-bindgen-react-native uniffi-bindgen-react-native || {
            echo "uniffi-bindgen-react-native install failed, will skip binding generation"
          }

      - name: Configure cargo for iOS
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << 'EOF'
          [target.aarch64-apple-ios]
          rustflags = ["-C", "link-arg=-mios-version-min=14.0"]

          [target.aarch64-apple-ios-sim]
          rustflags = ["-C", "link-arg=-mios-simulator-version-min=14.0"]
          EOF

      - name: Patch Cargo.toml for iOS (staticlib only)
        run: |
          sed -i '' 's/crate-type = \["lib", "staticlib", "cdylib"\]/crate-type = ["lib", "staticlib"]/' Cargo.toml
          cat Cargo.toml

      - name: Build native (generate circuit files)
        run: cargo build --release

      - name: Find circuit files directory
        id: circuit-files
        run: |
          BUILD_DIR=$(find target/release/build -maxdepth 2 -type d -name "out" -path "*mopro_example_app*" | head -1)
          echo "dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          mkdir -p /tmp/circuit_files

          if [ -n "$BUILD_DIR" ]; then
            echo "=== Found BUILD_DIR: $BUILD_DIR ==="
            echo "=== Full directory structure: ==="
            find "$BUILD_DIR" -type d | head -30

            # CRITICAL: Only copy preimage_poseidon circuit files!
            # Multiple circuits (multiplier2, preimage_poseidon) generate s0*.c files
            # with the same names. Copying all would cause overwrites.

            # Copy preimage_poseidon circuit files from its subdirectory
            POSEIDON_DIR="$BUILD_DIR/preimage_poseidon"
            if [ -d "$POSEIDON_DIR" ]; then
              echo "=== Copying preimage_poseidon files from $POSEIDON_DIR ==="
              cp "$POSEIDON_DIR"/*.c /tmp/circuit_files/ 2>/dev/null || true
              cp "$POSEIDON_DIR"/*.h /tmp/circuit_files/ 2>/dev/null || true
              echo "Copied $(ls "$POSEIDON_DIR"/*.c 2>/dev/null | wc -l) C files from preimage_poseidon/"
            else
              echo "WARNING: preimage_poseidon subdirectory not found!"
              echo "Available subdirectories:"
              ls -la "$BUILD_DIR"
            fi

            # Copy shared runtime files from BUILD_DIR root
            for file in globals.c handlers.c; do
              if [ -f "$BUILD_DIR/$file" ]; then
                cp "$BUILD_DIR/$file" /tmp/circuit_files/
                echo "Copied $file from BUILD_DIR root"
              fi
            done

            # Find w2c2_base.h - it's in the w2c2 repo which has structure w2c2/w2c2/w2c2_base.h
            echo "=== Searching for w2c2_base.h ==="
            W2C2_BASE=$(find "$BUILD_DIR" -name "w2c2_base.h" -type f | head -1)
            if [ -n "$W2C2_BASE" ]; then
              echo "Found w2c2_base.h at: $W2C2_BASE"
              cp "$W2C2_BASE" /tmp/circuit_files/
              # Also copy any other w2c2 headers from the same directory
              W2C2_DIR=$(dirname "$W2C2_BASE")
              echo "Copying all headers from w2c2 directory: $W2C2_DIR"
              cp "$W2C2_DIR"/*.h /tmp/circuit_files/ 2>/dev/null || true
            else
              echo "WARNING: w2c2_base.h not found in BUILD_DIR!"
              echo "Searching entire build directory..."
              find target/release/build -name "w2c2_base.h" -type f 2>/dev/null | head -5
            fi
          fi

          echo "=== Final circuit_files contents: ==="
          ls -la /tmp/circuit_files/ | head -40
          echo "Total C files: $(ls /tmp/circuit_files/*.c 2>/dev/null | wc -l)"
          echo "Total H files: $(ls /tmp/circuit_files/*.h 2>/dev/null | wc -l)"
          echo "=== Verify w2c2_base.h exists ==="
          ls -la /tmp/circuit_files/w2c2_base.h || echo "ERROR: w2c2_base.h missing!"

      - name: Fix circuit symbol names
        run: |
          # w2c2 generates symbols without underscore (preimageposeidon)
          # but Rust expects underscore (preimage_poseidon)
          # Rename all occurrences in C and H files
          echo "Fixing symbol names in circuit files..."
          for file in /tmp/circuit_files/*.c /tmp/circuit_files/*.h; do
            if [ -f "$file" ]; then
              # Rename function/symbol names: preimageposeidon -> preimage_poseidon
              sed -i '' 's/preimageposeidon/preimage_poseidon/g' "$file" 2>/dev/null || \
              sed -i 's/preimageposeidon/preimage_poseidon/g' "$file"
              echo "Patched: $file"
            fi
          done
          # Verify the fix
          echo "=== Checking for preimage_poseidon symbols ==="
          grep -l "preimage_poseidon" /tmp/circuit_files/*.c 2>/dev/null || echo "No .c files with symbol"

      - name: Patch w2c2 headers for iOS compatibility
        run: |
          # The w2c2-generated stddef.h includes Linux-specific headers
          # Remove it so the system stddef.h is used instead
          if [ -f /tmp/circuit_files/stddef.h ]; then
            echo "Removing custom stddef.h that has Linux-specific includes"
            rm /tmp/circuit_files/stddef.h
          fi

          # Also patch w2c2_base.h to use standard headers
          if [ -f /tmp/circuit_files/w2c2_base.h ]; then
            echo "Patching w2c2_base.h for iOS compatibility"
            # Replace custom header includes with standard ones
            sed -i '' 's|#include "stddef.h"|#include <stddef.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "stdint.h"|#include <stdint.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "inttypes.h"|#include <inttypes.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "math.h"|#include <math.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "string.h"|#include <string.h>|g' /tmp/circuit_files/w2c2_base.h
            cat /tmp/circuit_files/w2c2_base.h | head -20
          fi

          # Remove ALL custom standard library headers from w2c2
          # These all have Linux-specific includes that break iOS builds
          for header in stdint.h inttypes.h math.h string.h stdlib.h alloca.h \
                        stdio.h limits.h float.h stdbool.h stdarg.h errno.h \
                        ctype.h assert.h signal.h time.h locale.h setjmp.h \
                        fenv.h complex.h wchar.h wctype.h malloc.h; do
            if [ -f "/tmp/circuit_files/$header" ]; then
              echo "Removing custom $header"
              rm "/tmp/circuit_files/$header"
            fi
          done

          echo "=== Remaining circuit files ==="
          ls -la /tmp/circuit_files/

      - name: Build iOS device (arm64)
        env:
          IPHONEOS_DEPLOYMENT_TARGET: "14.0"
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
        run: cargo build --release --target aarch64-apple-ios

      - name: Build iOS simulator (arm64)
        env:
          IPHONEOS_DEPLOYMENT_TARGET: "14.0"
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
        run: cargo build --release --target aarch64-apple-ios-sim

      - name: Merge circuit library into main library (iOS)
        run: |
          # The circuit C code is compiled by cc-rs into libcircuit.a
          # We need to merge it with libmopro_example_app.a so all symbols are included

          WORK_DIR=$(pwd)

          for target in aarch64-apple-ios aarch64-apple-ios-sim; do
            echo "=== Merging libraries for $target ==="

            # Find the circuit library in the build directory (use absolute paths)
            CIRCUIT_LIB=$(find "$WORK_DIR/target/$target/release/build" -name "libcircuit.a" 2>/dev/null | head -1)
            MAIN_LIB="$WORK_DIR/target/$target/release/libmopro_example_app.a"

            if [ -n "$CIRCUIT_LIB" ] && [ -f "$CIRCUIT_LIB" ]; then
              echo "Found circuit lib: $CIRCUIT_LIB"
              echo "Main lib: $MAIN_LIB"

              # Create temp directory for merging
              MERGE_DIR=$(mktemp -d)
              cd "$MERGE_DIR"

              # Extract objects from both libraries (using absolute paths)
              ar x "$CIRCUIT_LIB"
              ar x "$MAIN_LIB"

              # List extracted objects
              echo "Extracted objects:"
              ls -la *.o 2>/dev/null | head -20

              # Create merged library using libtool for iOS compatibility
              libtool -static -o merged.a *.o 2>/dev/null || ar rcs merged.a *.o

              # Replace original library
              cp merged.a "$MAIN_LIB"

              cd "$WORK_DIR"
              rm -rf "$MERGE_DIR"

              echo "Merged library created for $target"
            else
              echo "Warning: Circuit library not found for $target"
              find "$WORK_DIR/target/$target/release/build" -name "*.a" 2>/dev/null | head -10
            fi
          done

      - name: Generate UniFFI bindings
        run: |
          mkdir -p generated/cpp generated/typescript

          # Generate C++ bindings for React Native
          uniffi-bindgen-react-native \
            --library target/release/libmopro_example_app.a \
            --out-dir generated \
            --language cpp \
            --language typescript \
            || echo "uniffi-bindgen-react-native failed, trying alternative"

      - name: Create XCFramework structure
        run: |
          mkdir -p output/MoproFfiFramework.xcframework/ios-arm64
          mkdir -p output/MoproFfiFramework.xcframework/ios-arm64-simulator
          mkdir -p output/ios
          mkdir -p output/cpp

          cp target/aarch64-apple-ios/release/libmopro_example_app.a \
             output/MoproFfiFramework.xcframework/ios-arm64/
          cp target/aarch64-apple-ios-sim/release/libmopro_example_app.a \
             output/MoproFfiFramework.xcframework/ios-arm64-simulator/

          # Copy generated bindings if they exist
          cp -R generated/* output/ 2>/dev/null || true

          # Create Info.plist for XCFramework
          cat > output/MoproFfiFramework.xcframework/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>AvailableLibraries</key>
            <array>
              <dict>
                <key>BinaryPath</key>
                <string>libmopro_example_app.a</string>
                <key>LibraryIdentifier</key>
                <string>ios-arm64</string>
                <key>LibraryPath</key>
                <string>libmopro_example_app.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
              </dict>
              <dict>
                <key>BinaryPath</key>
                <string>libmopro_example_app.a</string>
                <key>LibraryIdentifier</key>
                <string>ios-arm64-simulator</string>
                <key>LibraryPath</key>
                <string>libmopro_example_app.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
                <key>SupportedPlatformVariant</key>
                <string>simulator</string>
              </dict>
            </array>
            <key>CFBundlePackageType</key>
            <string>XFWK</string>
            <key>XCFrameworkFormatVersion</key>
            <string>1.0</string>
          </dict>
          </plist>
          EOF

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-bindings
          path: output/

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Configure cargo for Android
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"

          [target.armv7-linux-androideabi]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang"

          [target.x86_64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang"

          [target.i686-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang"
          EOF

      - name: Build native first (generate circuit files)
        run: cargo build --release

      - name: Find and prepare circuit files
        run: |
          BUILD_DIR=$(find target/release/build -maxdepth 2 -type d -name "out" -path "*mopro_example_app*" | head -1)
          mkdir -p /tmp/circuit_files

          if [ -n "$BUILD_DIR" ]; then
            echo "=== Found BUILD_DIR: $BUILD_DIR ==="
            echo "=== Full directory structure: ==="
            find "$BUILD_DIR" -type d | head -30

            # CRITICAL: Only copy preimage_poseidon circuit files!
            # Multiple circuits (multiplier2, preimage_poseidon) generate s0*.c files
            # with the same names. Copying all would cause overwrites.

            # Copy preimage_poseidon circuit files from its subdirectory
            POSEIDON_DIR="$BUILD_DIR/preimage_poseidon"
            if [ -d "$POSEIDON_DIR" ]; then
              echo "=== Copying preimage_poseidon files from $POSEIDON_DIR ==="
              cp "$POSEIDON_DIR"/*.c /tmp/circuit_files/ 2>/dev/null || true
              cp "$POSEIDON_DIR"/*.h /tmp/circuit_files/ 2>/dev/null || true
              echo "Copied $(ls "$POSEIDON_DIR"/*.c 2>/dev/null | wc -l) C files from preimage_poseidon/"
            else
              echo "WARNING: preimage_poseidon subdirectory not found!"
              echo "Available subdirectories:"
              ls -la "$BUILD_DIR"
            fi

            # Copy shared runtime files from BUILD_DIR root
            for file in globals.c handlers.c; do
              if [ -f "$BUILD_DIR/$file" ]; then
                cp "$BUILD_DIR/$file" /tmp/circuit_files/
                echo "Copied $file from BUILD_DIR root"
              fi
            done

            # Find w2c2_base.h - it's in the w2c2 repo which has structure w2c2/w2c2/w2c2_base.h
            echo "=== Searching for w2c2_base.h ==="
            W2C2_BASE=$(find "$BUILD_DIR" -name "w2c2_base.h" -type f | head -1)
            if [ -n "$W2C2_BASE" ]; then
              echo "Found w2c2_base.h at: $W2C2_BASE"
              cp "$W2C2_BASE" /tmp/circuit_files/
              # Also copy any other w2c2 headers from the same directory
              W2C2_DIR=$(dirname "$W2C2_BASE")
              echo "Copying all headers from w2c2 directory: $W2C2_DIR"
              cp "$W2C2_DIR"/*.h /tmp/circuit_files/ 2>/dev/null || true
            else
              echo "WARNING: w2c2_base.h not found in BUILD_DIR!"
              echo "Searching entire build directory..."
              find target/release/build -name "w2c2_base.h" -type f 2>/dev/null | head -5
            fi
          fi

          echo "=== Final circuit_files contents: ==="
          ls -la /tmp/circuit_files/ | head -40
          echo "Total C files: $(ls /tmp/circuit_files/*.c 2>/dev/null | wc -l)"
          echo "Total H files: $(ls /tmp/circuit_files/*.h 2>/dev/null | wc -l)"
          echo "=== Verify w2c2_base.h exists ==="
          ls -la /tmp/circuit_files/w2c2_base.h || echo "ERROR: w2c2_base.h missing!"

      - name: Fix circuit symbol names (Android)
        run: |
          # w2c2 generates symbols without underscore (preimageposeidon)
          # but Rust expects underscore (preimage_poseidon)
          # Rename all occurrences in C and H files
          echo "Fixing symbol names in circuit files..."
          for file in /tmp/circuit_files/*.c /tmp/circuit_files/*.h; do
            if [ -f "$file" ]; then
              # Rename function/symbol names: preimageposeidon -> preimage_poseidon
              sed -i 's/preimageposeidon/preimage_poseidon/g' "$file"
              echo "Patched: $file"
            fi
          done
          # Verify the fix
          echo "=== Checking for preimage_poseidon symbols ==="
          grep -l "preimage_poseidon" /tmp/circuit_files/*.c 2>/dev/null || echo "No .c files with symbol"

      - name: Patch w2c2 headers for Android compatibility
        run: |
          # Remove custom standard library headers that have Linux-specific includes
          # The NDK provides proper headers for Android
          for header in stddef.h stdint.h inttypes.h math.h string.h stdlib.h alloca.h \
                        stdio.h limits.h float.h stdbool.h stdarg.h errno.h \
                        ctype.h assert.h signal.h time.h locale.h setjmp.h \
                        fenv.h complex.h wchar.h wctype.h malloc.h strings.h; do
            if [ -f "/tmp/circuit_files/$header" ]; then
              echo "Removing custom $header"
              rm "/tmp/circuit_files/$header"
            fi
          done

          # Patch w2c2_base.h to use standard headers and fix locale_t issue
          if [ -f /tmp/circuit_files/w2c2_base.h ]; then
            echo "Patching w2c2_base.h for Android compatibility"

            # Replace quoted includes with angle bracket includes
            sed -i 's|#include "stddef.h"|#include <stddef.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "stdint.h"|#include <stdint.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "inttypes.h"|#include <inttypes.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "math.h"|#include <math.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "string.h"|#include <string.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "stdlib.h"|#include <stdlib.h>|g' /tmp/circuit_files/w2c2_base.h

            # Add locale_t typedef at the very beginning of the file
            # Android NDK's string.h/stdlib.h use locale_t but it's not always defined
            sed -i '1i\/* Android locale_t fix */\n#ifndef locale_t\n#define locale_t __locale_t\ntypedef struct __locale_struct* __locale_t;\n#endif' /tmp/circuit_files/w2c2_base.h

            echo "=== Patched w2c2_base.h (first 30 lines) ==="
            head -30 /tmp/circuit_files/w2c2_base.h
          fi

          echo "=== Remaining circuit files ==="
          ls -la /tmp/circuit_files/

      - name: Build Android arm64
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          CXX_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++
          AR_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target aarch64-linux-android

      - name: Build Android armv7
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang
          CXX_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang++
          AR_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target armv7-linux-androideabi

      - name: Build Android x86_64
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          CXX_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang++
          AR_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target x86_64-linux-android

      - name: Build Android x86
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang
          CXX_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang++
          AR_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target i686-linux-android

      - name: Merge circuit library into main library (Android)
        run: |
          # The circuit C code is compiled by cc-rs into libcircuit.a
          # We need to merge it with libmopro_example_app.a so all symbols are included

          WORK_DIR=$(pwd)

          for target in aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android; do
            echo "=== Merging libraries for $target ==="

            # Find the circuit library in the build directory (use absolute paths)
            CIRCUIT_LIB=$(find "$WORK_DIR/target/$target/release/build" -name "libcircuit.a" 2>/dev/null | head -1)
            MAIN_LIB="$WORK_DIR/target/$target/release/libmopro_example_app.a"

            if [ -n "$CIRCUIT_LIB" ] && [ -f "$CIRCUIT_LIB" ]; then
              echo "Found circuit lib: $CIRCUIT_LIB"
              echo "Main lib: $MAIN_LIB"

              # Create temp directory for merging
              MERGE_DIR=$(mktemp -d)
              cd "$MERGE_DIR"

              # Extract objects from both libraries (using absolute paths)
              ar x "$CIRCUIT_LIB"
              ar x "$MAIN_LIB"

              # List extracted objects
              echo "Extracted objects:"
              ls -la *.o 2>/dev/null | head -20

              # Create merged library
              ar rcs merged.a *.o

              # Replace original library
              cp merged.a "$MAIN_LIB"

              cd "$WORK_DIR"
              rm -rf "$MERGE_DIR"

              echo "Merged library created for $target"
            else
              echo "Warning: Circuit library not found for $target"
              find "$WORK_DIR/target/$target/release/build" -name "*.a" 2>/dev/null | head -10
            fi
          done

      - name: Package Android libraries
        run: |
          mkdir -p output/android/arm64-v8a
          mkdir -p output/android/armeabi-v7a
          mkdir -p output/android/x86_64
          mkdir -p output/android/x86

          cp target/aarch64-linux-android/release/libmopro_example_app.a output/android/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libmopro_example_app.a output/android/armeabi-v7a/
          cp target/x86_64-linux-android/release/libmopro_example_app.a output/android/x86_64/
          cp target/i686-linux-android/release/libmopro_example_app.a output/android/x86/

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-bindings
          path: output/

  combine:
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-bindings
          path: combined/

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-bindings
          path: combined/

      - name: Create combined package
        run: |
          cd combined
          echo "=== Combined package contents ==="
          find . -type f
          zip -r ../mopro-poseidon-bindings.zip .

      - name: Upload combined package
        uses: actions/upload-artifact@v4
        with:
          name: mopro-poseidon-complete
          path: mopro-poseidon-bindings.zip
