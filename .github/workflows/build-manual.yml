name: Build Bindings (Manual - No Mopro CLI)

on:
  workflow_dispatch:  # Manual trigger only

env:
  CARGO_TERM_COLOR: always

jobs:
  build-ios:
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios,aarch64-apple-ios-sim

      - name: Install uniffi-bindgen-react-native
        run: |
          # Install from git - not on crates.io
          cargo install --git https://github.com/jhugman/uniffi-bindgen-react-native uniffi-bindgen-react-native || {
            echo "uniffi-bindgen-react-native install failed, will skip binding generation"
          }

      - name: Configure cargo for iOS
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << 'EOF'
          [target.aarch64-apple-ios]
          rustflags = ["-C", "link-arg=-mios-version-min=14.0"]

          [target.aarch64-apple-ios-sim]
          rustflags = ["-C", "link-arg=-mios-simulator-version-min=14.0"]
          EOF

      - name: Patch Cargo.toml for iOS (staticlib only)
        run: |
          sed -i '' 's/crate-type = \["lib", "staticlib", "cdylib"\]/crate-type = ["lib", "staticlib"]/' Cargo.toml
          cat Cargo.toml

      - name: Build native (generate circuit files)
        run: cargo build --release

      - name: Find circuit files directory
        id: circuit-files
        run: |
          BUILD_DIR=$(find target/release/build -maxdepth 2 -type d -name "out" -path "*mopro_example_app*" | head -1)
          echo "dir=$BUILD_DIR" >> $GITHUB_OUTPUT
          mkdir -p /tmp/circuit_files
          if [ -n "$BUILD_DIR" ]; then
            find "$BUILD_DIR" -name "*.c" -exec cp {} /tmp/circuit_files/ \;
            find "$BUILD_DIR" -name "*.h" -exec cp {} /tmp/circuit_files/ \;
          fi
          ls -la /tmp/circuit_files/

      - name: Patch w2c2 headers for iOS compatibility
        run: |
          # The w2c2-generated stddef.h includes Linux-specific headers
          # Remove it so the system stddef.h is used instead
          if [ -f /tmp/circuit_files/stddef.h ]; then
            echo "Removing custom stddef.h that has Linux-specific includes"
            rm /tmp/circuit_files/stddef.h
          fi

          # Also patch w2c2_base.h to use standard headers
          if [ -f /tmp/circuit_files/w2c2_base.h ]; then
            echo "Patching w2c2_base.h for iOS compatibility"
            # Replace custom header includes with standard ones
            sed -i '' 's|#include "stddef.h"|#include <stddef.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "stdint.h"|#include <stdint.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "inttypes.h"|#include <inttypes.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "math.h"|#include <math.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i '' 's|#include "string.h"|#include <string.h>|g' /tmp/circuit_files/w2c2_base.h
            cat /tmp/circuit_files/w2c2_base.h | head -20
          fi

          # Remove ALL custom standard library headers from w2c2
          # These all have Linux-specific includes that break iOS builds
          for header in stdint.h inttypes.h math.h string.h stdlib.h alloca.h \
                        stdio.h limits.h float.h stdbool.h stdarg.h errno.h \
                        ctype.h assert.h signal.h time.h locale.h setjmp.h \
                        fenv.h complex.h wchar.h wctype.h malloc.h; do
            if [ -f "/tmp/circuit_files/$header" ]; then
              echo "Removing custom $header"
              rm "/tmp/circuit_files/$header"
            fi
          done

          echo "=== Remaining circuit files ==="
          ls -la /tmp/circuit_files/

      - name: Build iOS device (arm64)
        env:
          IPHONEOS_DEPLOYMENT_TARGET: "14.0"
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
        run: cargo build --release --target aarch64-apple-ios

      - name: Build iOS simulator (arm64)
        env:
          IPHONEOS_DEPLOYMENT_TARGET: "14.0"
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
        run: cargo build --release --target aarch64-apple-ios-sim

      - name: Generate UniFFI bindings
        run: |
          mkdir -p generated/cpp generated/typescript

          # Generate C++ bindings for React Native
          uniffi-bindgen-react-native \
            --library target/release/libmopro_example_app.a \
            --out-dir generated \
            --language cpp \
            --language typescript \
            || echo "uniffi-bindgen-react-native failed, trying alternative"

      - name: Create XCFramework structure
        run: |
          mkdir -p output/MoproFfiFramework.xcframework/ios-arm64
          mkdir -p output/MoproFfiFramework.xcframework/ios-arm64-simulator
          mkdir -p output/ios
          mkdir -p output/cpp

          cp target/aarch64-apple-ios/release/libmopro_example_app.a \
             output/MoproFfiFramework.xcframework/ios-arm64/
          cp target/aarch64-apple-ios-sim/release/libmopro_example_app.a \
             output/MoproFfiFramework.xcframework/ios-arm64-simulator/

          # Copy generated bindings if they exist
          cp -R generated/* output/ 2>/dev/null || true

          # Create Info.plist for XCFramework
          cat > output/MoproFfiFramework.xcframework/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>AvailableLibraries</key>
            <array>
              <dict>
                <key>BinaryPath</key>
                <string>libmopro_example_app.a</string>
                <key>LibraryIdentifier</key>
                <string>ios-arm64</string>
                <key>LibraryPath</key>
                <string>libmopro_example_app.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
              </dict>
              <dict>
                <key>BinaryPath</key>
                <string>libmopro_example_app.a</string>
                <key>LibraryIdentifier</key>
                <string>ios-arm64-simulator</string>
                <key>LibraryPath</key>
                <string>libmopro_example_app.a</string>
                <key>SupportedArchitectures</key>
                <array>
                  <string>arm64</string>
                </array>
                <key>SupportedPlatform</key>
                <string>ios</string>
                <key>SupportedPlatformVariant</key>
                <string>simulator</string>
              </dict>
            </array>
            <key>CFBundlePackageType</key>
            <string>XFWK</string>
            <key>XCFrameworkFormatVersion</key>
            <string>1.0</string>
          </dict>
          </plist>
          EOF

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-bindings
          path: output/

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-linux-android,armv7-linux-androideabi,x86_64-linux-android,i686-linux-android

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26b

      - name: Configure cargo for Android
        run: |
          mkdir -p ~/.cargo
          cat >> ~/.cargo/config.toml << EOF
          [target.aarch64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang"

          [target.armv7-linux-androideabi]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang"

          [target.x86_64-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang"

          [target.i686-linux-android]
          linker = "${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang"
          EOF

      - name: Build native first (generate circuit files)
        run: cargo build --release

      - name: Find and prepare circuit files
        run: |
          BUILD_DIR=$(find target/release/build -maxdepth 2 -type d -name "out" -path "*mopro_example_app*" | head -1)
          mkdir -p /tmp/circuit_files
          if [ -n "$BUILD_DIR" ]; then
            echo "Found circuit files in: $BUILD_DIR"
            find "$BUILD_DIR" -name "*.c" -exec cp {} /tmp/circuit_files/ \;
            find "$BUILD_DIR" -name "*.h" -exec cp {} /tmp/circuit_files/ \;
          fi
          echo "=== Circuit files ==="
          ls -la /tmp/circuit_files/

      - name: Patch w2c2 headers for Android compatibility
        run: |
          # Remove custom standard library headers that have Linux-specific includes
          # The NDK provides proper headers for Android
          for header in stddef.h stdint.h inttypes.h math.h string.h stdlib.h alloca.h \
                        stdio.h limits.h float.h stdbool.h stdarg.h errno.h \
                        ctype.h assert.h signal.h time.h locale.h setjmp.h \
                        fenv.h complex.h wchar.h wctype.h malloc.h strings.h; do
            if [ -f "/tmp/circuit_files/$header" ]; then
              echo "Removing custom $header"
              rm "/tmp/circuit_files/$header"
            fi
          done

          # Patch w2c2_base.h to use standard headers and fix locale_t issue
          if [ -f /tmp/circuit_files/w2c2_base.h ]; then
            echo "Patching w2c2_base.h for Android compatibility"

            # Replace quoted includes with angle bracket includes
            sed -i 's|#include "stddef.h"|#include <stddef.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "stdint.h"|#include <stdint.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "inttypes.h"|#include <inttypes.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "math.h"|#include <math.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "string.h"|#include <string.h>|g' /tmp/circuit_files/w2c2_base.h
            sed -i 's|#include "stdlib.h"|#include <stdlib.h>|g' /tmp/circuit_files/w2c2_base.h

            # Add locale_t typedef at the very beginning of the file
            # Android NDK's string.h/stdlib.h use locale_t but it's not always defined
            sed -i '1i\/* Android locale_t fix */\n#ifndef locale_t\n#define locale_t __locale_t\ntypedef struct __locale_struct* __locale_t;\n#endif' /tmp/circuit_files/w2c2_base.h

            echo "=== Patched w2c2_base.h (first 30 lines) ==="
            head -30 /tmp/circuit_files/w2c2_base.h
          fi

          echo "=== Remaining circuit files ==="
          ls -la /tmp/circuit_files/

      - name: Build Android arm64
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang
          CXX_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android24-clang++
          AR_aarch64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target aarch64-linux-android

      - name: Build Android armv7
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang
          CXX_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi24-clang++
          AR_armv7-linux-androideabi: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target armv7-linux-androideabi

      - name: Build Android x86_64
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang
          CXX_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android24-clang++
          AR_x86_64-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target x86_64-linux-android

      - name: Build Android x86
        env:
          CIRCUIT_C_FILES_DIR: /tmp/circuit_files
          CC_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang
          CXX_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android24-clang++
          AR_i686-linux-android: ${{ steps.setup-ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
        run: cargo build --release --target i686-linux-android

      - name: Package Android libraries
        run: |
          mkdir -p output/android/arm64-v8a
          mkdir -p output/android/armeabi-v7a
          mkdir -p output/android/x86_64
          mkdir -p output/android/x86

          cp target/aarch64-linux-android/release/libmopro_example_app.a output/android/arm64-v8a/
          cp target/armv7-linux-androideabi/release/libmopro_example_app.a output/android/armeabi-v7a/
          cp target/x86_64-linux-android/release/libmopro_example_app.a output/android/x86_64/
          cp target/i686-linux-android/release/libmopro_example_app.a output/android/x86/

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-bindings
          path: output/

  combine:
    needs: [build-ios, build-android]
    runs-on: ubuntu-latest
    steps:
      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-bindings
          path: combined/

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-bindings
          path: combined/

      - name: Create combined package
        run: |
          cd combined
          echo "=== Combined package contents ==="
          find . -type f
          zip -r ../mopro-poseidon-bindings.zip .

      - name: Upload combined package
        uses: actions/upload-artifact@v4
        with:
          name: mopro-poseidon-complete
          path: mopro-poseidon-bindings.zip
